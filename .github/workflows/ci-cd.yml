name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches: ["*"]
  workflow_dispatch:

env:
  BACKEND_HOST: ${{ secrets.BACKEND_HOST }}
  BACKEND_PORT: ${{ secrets.BACKEND_PORT }}
  AUTH_HOST: ${{ secrets.AUTH_HOST }}
  AUTH_PORT: ${{ secrets.AUTH_PORT }}
  GIGACHAT_PROXY_HOST: ${{ secrets.GIGACHAT_PROXY_HOST }}
  GIGACHAT_PROXY_PORT: ${{ secrets.GIGACHAT_PROXY_PORT }}
  GIGACHAT_AUTH_KEY: ${{ secrets.GIGACHAT_AUTH_KEY }}
  FRONTEND_HOST: ${{ secrets.FRONTEND_HOST }}
  FRONTEND_PORT: ${{ secrets.FRONTEND_PORT }}
  VITE_STORAGE_API_BASE_URL: https://localhost:${{ secrets.BACKEND_PORT }}
  VITE_AUTH_API_BASE_URL: https://localhost:${{ secrets.AUTH_PORT }}
  VITE_GIGACHAT_PROXY_API_BASE_URL: https://localhost:${{ secrets.GIGACHAT_PROXY_PORT }}

  DB_HOST: markdown-db
  DB_PORT: ${{ secrets.DB_PORT }}
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_SSLMODE: disable

  JWT_SECRET: ${{ secrets.JWT_SECRET }}

  GF_SECURITY_ADMIN_USER: ${{ secrets.GF_SECURITY_ADMIN_USER }}
  GF_SECURITY_ADMIN_PASSWORD: ${{ secrets.GF_SECURITY_ADMIN_PASSWORD }}

jobs:
  test-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Golang
        uses: actions/setup-go@v6
        with:
          go-version: v1.24.0
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.64.7
          args: --disable-all --enable=govet --enable=errcheck --enable=staticcheck --enable=gofmt --enable=typecheck --timeout=5m
          working-directory: ./backend

      - name: Create .env file
        run: |
          cat << EOF > .env
          JWT_SECRET=test-secret
          EOF

      - name: Run tests
        run: go test ./... -v

      - name: Build application
        run: go build -o app .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-backend
          path: ./backend/app

  backend-health-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    needs: test-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: go-backend
          path: ./backend

      - name: Make binary executable
        run: chmod +x app

      - name: Generate TLS certificates
        run: |
          mkdir -p tls
          openssl req -x509 -newkey rsa:4096 -keyout tls/key.crt -out tls/cert_backend.crt -days 365 -nodes -subj "/CN=localhost"

      - name: Create .env file
        run: |
          cat << EOF > .env
          JWT_SECRET=$JWT_SECRET
          EOF

      - name: Start application
        run: |
          ./app --host=$BACKEND_HOST --port=$BACKEND_PORT &
          echo $! > app.pid
          sleep 7

      - name: Check backend health with retry
        run: |
          for i in {1..5}; do
            echo "Attempt $i"
            status_code=$(curl -k -s -o /dev/null -w "%{http_code}" $VITE_STORAGE_API_BASE_URL/health || echo "000")
            if [ "$status_code" -eq 200 ]; then
              echo "Health check passed"
              exit 0
            else
              echo "Health check attempt $i failed: HTTPS $status_code"
              sleep 3
            fi
          done
          echo "Health check failed after 5 attempts"
          exit 1

      - name: Stop application
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) 2>/dev/null || true
            rm -f app.pid
          fi

  test-auth-service:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./auth

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Golang
        uses: actions/setup-go@v6
        with:
          go-version: v1.24.0
          cache: true

      - name: Run tests
        run: go test -v

  build-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install frontend dependencies
        run: npm install

      - name: Build frontend
        run: npm run build

  test-docker-compose:
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend, test-auth-service]
    outputs:
      backend-image: ${{ steps.build-backend.outputs.image }}
      auth-image: ${{ steps.build-auth.outputs.image }}
      frontend-image: ${{ steps.build-frontend.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate TLS certificates for backend
        run: |
          mkdir -p backend/tls
          openssl req -x509 -newkey rsa:4096 -keyout backend/tls/key.crt -out backend/tls/cert_backend.crt -days 365 -nodes -subj "/CN=localhost"

      - name: Generate TLS certificates for auth
        run: |
          mkdir -p auth/tls
          openssl req -x509 -newkey rsa:4096 -keyout auth/tls/key.crt -out auth/tls/cert_auth.crt -days 365 -nodes -subj "/CN=localhost"

      - name: Generate TLS certificates for gigachat proxy
        run: |
          mkdir -p gigachat_proxy/tls
          openssl req -x509 -newkey rsa:4096 -keyout gigachat_proxy/tls/key.crt -out gigachat_proxy/tls/cert_backend.crt -days 365 -nodes -subj "/CN=localhost"

      - name: Create .env file for Docker Compose
        run: |
          cat << EOF > .env
          BACKEND_HOST=$BACKEND_HOST
          BACKEND_PORT=$BACKEND_PORT
          AUTH_HOST=$AUTH_HOST
          AUTH_PORT=$AUTH_PORT
          FRONTEND_HOST=$FRONTEND_HOST
          FRONTEND_PORT=$FRONTEND_PORT
          VITE_STORAGE_API_BASE_URL=$VITE_STORAGE_API_BASE_URL
          VITE_AUTH_API_BASE_URL=$VITE_AUTH_API_BASE_URL
          JWT_SECRET=$JWT_SECRET
          DB_HOST=$DB_HOST
          DB_PORT=$DB_PORT
          DB_USER=$DB_USER
          DB_PASSWORD=$DB_PASSWORD
          DB_NAME=$DB_NAME
          DB_SSLMODE=$DB_SSLMODE
          GF_SECURITY_ADMIN_USER=$GF_SECURITY_ADMIN_USER
          GF_SECURITY_ADMIN_PASSWORD=$GF_SECURITY_ADMIN_PASSWORD
          EOF

      - name: Deploy with Docker Compose
        run: |
          docker compose down --remove-orphans
          docker compose up -d --build

      - name: Verify deployment
        run: |
          sleep 15
          docker compose ps
          if [ $(docker compose ps --services | grep -c 'backend\|frontend\|auth') -ne 3 ]; then
            echo "Not all services are running"
            docker compose logs --tail=50
            exit 1
          fi

          echo "Checking backend health at https://$BACKEND_HOST:$BACKEND_PORT/health"
          if ! curl -k -f -v -s -S -o /dev/null -w "HTTPS Status: %{http_code}\n" "https://$BACKEND_HOST:$BACKEND_PORT/health"; 
          then
            echo "ERROR: Backend health check failed!"
            echo "Backend logs:"
            docker compose logs backend --tail=35
            exit 1
          else
            echo "Backend health check passed!"
          fi

          echo "Checking auth health at https://$AUTH_HOST:$AUTH_PORT/health"
          if ! curl -k -f -v -s -S -o /dev/null -w "HTTPS Status: %{http_code}\n" "https://$AUTH_HOST:$AUTH_PORT/health"; 
          then
            echo "ERROR: Auth health check failed!"
            echo "Auth logs:"
            docker compose logs auth --tail=35
            exit 1
          else
            echo "Auth health check passed!"
          fi

          echo "Checking frontend availability at http://$FRONTEND_HOST:$FRONTEND_PORT"
          if ! curl -f -v -s -S -o /dev/null -w "HTTP Status: %{http_code}\n" "http://$FRONTEND_HOST:$FRONTEND_PORT"; 
          then
            echo "ERROR: Frontend availability check failed!"
            echo "Frontend logs:"
            docker compose logs frontend --tail=35
            exit 1
          else
            echo "Frontend availability check passed!"
            docker compose logs frontend --tail=35
          fi

          echo "All services are healthy and responding!"

  build-and-push-docker-images:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [test-docker-compose]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/markdown-backend:latest

      - name: Build and push auth-service image
        uses: docker/build-push-action@v4
        with:
          context: ./auth
          file: ./auth/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/markdown-auth:latest

      - name: Build and push frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/markdown-frontend:latest
